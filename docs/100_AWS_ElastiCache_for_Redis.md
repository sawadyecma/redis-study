# 要件
## ノードインスタンス
- まず最初に必要なメモリ量を決める
    - その後、シャードのON/OFFをコスト計算して決める
- 書き込み負荷
    - 時間帯によってかなり変わる
    - BGSAVEが実行されるとメモリを多く使う
    - 
- スタンドアロンか複数シャードか
    - メモリ量による

## VPCか
基本Yesが推奨
開発・テストのときのみVPNからのアクセスも許容

## パラメーター
調査が必要

## セキュリティグループ
適切に設定すればOK

## 耐障害性

### Redis Append Only Files(AOF)
ResisでAOFが有効になっている場合、データ書き込み時にAOFへの書き込みもされる。
Redisプロセスが再起動されると、ElastiCacheが大替のクラスターを作成し、プロビジョニングする。
次にクラスターに対してAOFを実行してデータを再入力する。

#### 欠点
- クラスターの作成とプロビジョニングには時間がかかる
    AOFのサイズによっては、アプリケーションがクラスターデータにアクセスできない時間が多くなる。
- AOFは多くなる
    多くなる一方なので、ディスク容量を圧迫する
- 全ての障害ケースに対応できるわけではない
    物理サーバーのハードウェア障害でノードが落ちた場合、ElastiCacheは新しいノードを往路ビジョンする。
    このとき、AOFは利用できないため。リカバーできない

### レプリケーショングループ
read/writeどちらも可能な単一のプライマリノードと、1~5個のreadonlyレプリカノードで構成される。→ max 5個
データがプライマリノードに書き込まれると、常にリードレプリカでデータが非同期的に更新される。
クラスターあたり最大90ノード。
シャード90/レプリカ0 ~ シャード15/レプリカ5 = 15 x (1+5)=90

#### リードレプリカが失敗した場合
- ElastiCache が、失敗したリードレプリカを検出。
- ElastiCache が、障害のあるノードをオフラインにする。
- ElastiCache が、同じ AZ の代替のノードを起動し、プロビジョニング。

新しいノードがプライマリノードと同期される。

#### マルチAZ有効で、プライマリーノードが失敗した場合
- ElastiCache がプライマリノードの失敗を検出。
- ElastiCache が、レプリケーションの遅延が最も小さいリードレプリカノードをプライマリノードに昇格。
- 他のレプリカと新しいプライマリノードを同期。
- ElastiCache が、障害が発生したプライマリの AZ のリードレプリカをスピンアップします。
- 新しいノードが、新たに昇格されたプライマリと同期されます。

レプリカノードへのフェイルオーバーは、通常、新しいプライマリノードを作成してプロビジョニングするより高速。
つまり、マルチ AZ が有効でない場合と比べて、アプリケーションはプライマリノードへの書き込みをすばやく再開可能。

#### クラスター全体が失敗した場合の障害シナリオ
元のノードと同じAZで再作成され、プロビジョニングされる。
クラスター内のデータが失われる。

#### マルチ AZ による ElastiCache for Redis のダウンタイムの最小化
- ElastiCache は昇格されたレプリカのドメイン名サービス (DNS) 名を伝達する
    エンドポイントの変更は不要になる
- 再プロビジョニングするより早い

#### 自動フェイルオーバーテスト
aws cliを使用してテストできる
- 24時間あたりmax5つのシャードで自動フェイルオーバーテストをできる


### マルチAZ
マルチAZにすべき